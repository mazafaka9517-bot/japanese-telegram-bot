# -*- coding: utf-8 -*-
import logging
import sqlite3
import random
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters

# --- 1. –ù–ê–°–¢–†–û–ô–ö–ò –ò –ë–ê–ó–ê –î–ê–ù–ù–´–• ---
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite (—Ñ–∞–π–ª bot_data.db —Å–æ–∑–¥–∞—Å—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
conn = sqlite3.connect('bot_data.db', check_same_thread=False)
cursor = conn.cursor()

# –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
cursor.execute('''
CREATE TABLE IF NOT EXISTS words (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,
    original TEXT,
    translation TEXT
)
''')
cursor.execute('''
CREATE TABLE IF NOT EXISTS kanji (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,
    character TEXT,
    meaning TEXT,
    reading TEXT
)
''')
cursor.execute('''
CREATE TABLE IF NOT EXISTS grammar (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,
    pattern TEXT,
    explanation TEXT
)
''')
conn.commit()

# --- 2. –ö–û–ú–ê–ù–î–´ –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ö–ê–†–¢–û–ß–ï–ö ---
async def add_word(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /add_word. –§–æ—Ä–º–∞—Ç: —Å–ª–æ–≤–æ - –ø–µ—Ä–µ–≤–æ–¥"""
    try:
        user_id = update.effective_user.id
        text = update.message.text.replace('/add_word', '').strip()
        if ' - ' not in text:
            await update.message.reply_text('‚ùå –§–æ—Ä–º–∞—Ç: /add_word –¥–æ–º - „ÅÑ„Åà')
            return
        original, translation = text.split(' - ', 1)
        cursor.execute('INSERT INTO words (user_id, original, translation) VALUES (?, ?, ?)',
                       (user_id, original.strip(), translation.strip()))
        conn.commit()
        await update.message.reply_text(f'‚úÖ –°–ª–æ–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ: {original.strip()} -> {translation.strip()}')
    except Exception as e:
        await update.message.reply_text('‚ö†Ô∏è –û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç: /add_word –¥–æ–º - „ÅÑ„Åà')

async def add_kanji(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /add_kanji. –§–æ—Ä–º–∞—Ç: Ê∞¥ - –≤–æ–¥–∞, „Åø„Åö"""
    try:
        user_id = update.effective_user.id
        text = update.message.text.replace('/add_kanji', '').strip()
        if ' - ' not in text:
            await update.message.reply_text('‚ùå –§–æ—Ä–º–∞—Ç: /add_kanji Ê∞¥ - –≤–æ–¥–∞, „Åø„Åö')
            return
        character, rest = text.split(' - ', 1)
        if ', ' not in rest:
            meaning, reading = rest, ''
        else:
            meaning, reading = rest.split(', ', 1)
        cursor.execute('INSERT INTO kanji (user_id, character, meaning, reading) VALUES (?, ?, ?, ?)',
                       (user_id, character.strip(), meaning.strip(), reading.strip()))
        conn.commit()
        await update.message.reply_text(f'‚úÖ –ö–∞–Ω–¥–∑–∏ –¥–æ–±–∞–≤–ª–µ–Ω: {character.strip()} -> {meaning.strip()}')
    except Exception as e:
        await update.message.reply_text('‚ö†Ô∏è –û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç: /add_kanji Ê∞¥ - –≤–æ–¥–∞, „Åø„Åö')

async def add_grammar(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /add_grammar. –§–æ—Ä–º–∞—Ç: ÔΩû„Åæ„Åô - –≤–µ–∂–ª–∏–≤–∞—è —Ñ–æ—Ä–º–∞ –≥–ª–∞–≥–æ–ª–∞"""
    try:
        user_id = update.effective_user.id
        text = update.message.text.replace('/add_grammar', '').strip()
        if ' - ' not in text:
            await update.message.reply_text('‚ùå –§–æ—Ä–º–∞—Ç: /add_grammar ÔΩû„Åæ„Åô - –≤–µ–∂–ª–∏–≤–∞—è —Ñ–æ—Ä–º–∞ –≥–ª–∞–≥–æ–ª–∞')
            return
        pattern, explanation = text.split(' - ', 1)
        cursor.execute('INSERT INTO grammar (user_id, pattern, explanation) VALUES (?, ?, ?)',
                       (user_id, pattern.strip(), explanation.strip()))
        conn.commit()
        await update.message.reply_text(f'‚úÖ –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: {pattern.strip()}')
    except Exception as e:
        await update.message.reply_text('‚ö†Ô∏è –û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç.')

# --- 3. –ö–û–ú–ê–ù–î–ê –¢–†–ï–ù–ò–†–û–í–ö–ò /train ---
async def train(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É: —Å–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∏–ø –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å"""
    user_id = update.effective_user.id
    context.user_data['awaiting_answer'] = False  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞

    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    all_cards = []
    
    # –°–ª–æ–≤–∞
    cursor.execute('SELECT id, original, translation FROM words WHERE user_id = ?', (user_id,))
    for row in cursor.fetchall():
        all_cards.append(('word', row[0], f"–°–ª–æ–≤–æ: {row[1]}", row[2]))
    
    # –ö–∞–Ω–¥–∑–∏
    cursor.execute('SELECT id, character, meaning, reading FROM kanji WHERE user_id = ?', (user_id,))
    for row in cursor.fetchall():
        display = f"{row[1]} (—á—Ç–µ–Ω–∏–µ: {row[3]})" if row[3] else row[1]
        all_cards.append(('kanji', row[0], f"–ö–∞–Ω–¥–∑–∏: {display}", row[2]))
    
    # –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞
    cursor.execute('SELECT id, pattern, explanation FROM grammar WHERE user_id = ?', (user_id,))
    for row in cursor.fetchall():
        all_cards.append(('grammar', row[0], f"–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞: {row[1]}", row[2]))
    
    if not all_cards:
        await update.message.reply_text('üì≠ –ö–æ–ª–æ–¥–∞ –ø—É—Å—Ç–∞! –î–æ–±–∞–≤—å –∫–∞—Ä—Ç–æ—á–∫–∏ —á–µ—Ä–µ–∑ /add_word, /add_kanji, /add_grammar')
        return
    
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
    card_type, card_id, question, correct_answer = random.choice(all_cards)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    context.user_data['correct_answer'] = correct_answer
    context.user_data['awaiting_answer'] = True
    context.user_data['card_type'] = card_type
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await update.message.reply_text(f'üéå –í–û–ü–†–û–°:\n{question}\n\n–ù–∞–ø–∏—à–∏ –æ—Ç–≤–µ—Ç:')

# --- 4. –ü–†–û–í–ï–†–ö–ê –û–¢–í–ï–¢–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
async def check_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏"""
    if not context.user_data.get('awaiting_answer', False):
        return  # –ù–µ –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
    
    user_answer = update.message.text.strip()
    correct_answer = context.user_data.get('correct_answer', '')
    card_type = context.user_data.get('card_type', '')
    
    # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)
    is_correct = user_answer.lower() == correct_answer.lower()
    
    if is_correct:
        await update.message.reply_text(f'‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ! –û—Ç–≤–µ—Ç: {correct_answer}\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? /train')
    else:
        await update.message.reply_text(f'‚ùå –ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {correct_answer}\n\n–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë? /train')
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–∂–∏–¥–∞–Ω–∏—è
    context.user_data['awaiting_answer'] = False

# --- 5. –°–¢–ê–¢–ò–°–¢–ò–ö–ê /stats ---
async def stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º"""
    user_id = update.effective_user.id
    
    cursor.execute('SELECT COUNT(*) FROM words WHERE user_id = ?', (user_id,))
    word_count = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM kanji WHERE user_id = ?', (user_id,))
    kanji_count = cursor.fetchone()[0]
    
    cursor.execute('SELECT COUNT(*) FROM grammar WHERE user_id = ?', (user_id,))
    grammar_count = cursor.fetchone()[0]
    
    total = word_count + kanji_count + grammar_count
    
    message = f'üìä –¢–í–û–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:\n'
    message += f'‚Ä¢ –°–ª–æ–≤: {word_count}\n'
    message += f'‚Ä¢ –ö–∞–Ω–¥–∑–∏: {kanji_count}\n'
    message += f'‚Ä¢ –ì—Ä–∞–º–º. –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π: {grammar_count}\n'
    message += f'‚Ä¢ –í—Å–µ–≥–æ –∫–∞—Ä—Ç–æ—á–µ–∫: {total}\n\n'
    message += f'–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º? /train'
    
    await update.message.reply_text(message)

# --- 6. –ö–û–ú–ê–ù–î–ê /start –ò –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /start –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    keyboard = [
        [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ", callback_data='add_word_btn')],
        [InlineKeyboardButton("üî§ –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–¥–∑–∏", callback_data='add_kanji_btn')],
        [InlineKeyboardButton("üìù –î–æ–±–∞–≤–∏—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏–∫—É", callback_data='add_grammar_btn')],
        [InlineKeyboardButton("üéå –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", callback_data='train_btn')],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data='stats_btn')],
        [InlineKeyboardButton("‚ÑπÔ∏è –ü–æ–º–æ—â—å", callback_data='help_btn')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    welcome_text = """
    üéå *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, —Å–∞–º—É—Ä–∞–π!* 

    –Ø ‚Äî —Ç–≤–æ–π –ª–∏—á–Ω—ã–π —É—á–∏—Ç–µ–ª—å —è–ø–æ–Ω—Å–∫–æ–≥–æ.
    –° –º–æ–µ–π –ø–æ–º–æ—â—å—é —Ç—ã —Å–º–æ–∂–µ—à—å:
    ‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–ª–æ–≤–∞, –∫–∞–Ω–¥–∑–∏ –∏ –≥—Ä–∞–º–º–∞—Ç–∏–∫—É
    ‚Ä¢ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è
    ‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å

    *–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã:*
    /add_word - –î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ (–¥–æ–º - „ÅÑ„Åà)
    /add_kanji - –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–¥–∑–∏ (Ê∞¥ - –≤–æ–¥–∞, „Åø„Åö)
    /add_grammar - –î–æ–±–∞–≤–∏—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏–∫—É (ÔΩû„Åæ„Åô - –≤–µ–∂–ª–∏–≤–∞—è —Ñ–æ—Ä–º–∞)
    /train - –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
    /stats - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    """
    
    await update.message.reply_text(welcome_text, reply_markup=reply_markup, parse_mode='Markdown')

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é"""
    query = update.callback_query
    await query.answer()
    
    if query.data == 'add_word_btn':
        await query.edit_message_text(text="üìù –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ, –æ—Ç–ø—Ä–∞–≤—å:\n`/add_word –¥–æ–º - „ÅÑ„Åà`", parse_mode='Markdown')
    elif query.data == 'add_kanji_btn':
        await query.edit_message_text(text="üî§ –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–¥–∑–∏, –æ—Ç–ø—Ä–∞–≤—å:\n`/add_kanji Ê∞¥ - –≤–æ–¥–∞, „Åø„Åö`", parse_mode='Markdown')
    elif query.data == 'add_grammar_btn':
        await query.edit_message_text(text="üìñ –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏–∫—É, –æ—Ç–ø—Ä–∞–≤—å:\n`/add_grammar ÔΩû„Åæ„Åô - –≤–µ–∂–ª–∏–≤–∞—è —Ñ–æ—Ä–º–∞ –≥–ª–∞–≥–æ–ª–∞`", parse_mode='Markdown')
    elif query.data == 'train_btn':
        await train(update, context)  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
    elif query.data == 'stats_btn':
        await stats(update, context)  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
    elif query.data == 'help_btn':
        help_text = """
        *üìö –ü–û–ú–û–©–¨*

        *–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫:*
        ‚Ä¢ –°–ª–æ–≤–æ: `/add_word –¥–æ–º - „ÅÑ„Åà`
        ‚Ä¢ –ö–∞–Ω–¥–∑–∏: `/add_kanji Ê∞¥ - –≤–æ–¥–∞, „Åø„Åö`
        ‚Ä¢ –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞: `/add_grammar ÔΩû„Åæ„Åô - –≤–µ–∂–ª–∏–≤–∞—è —Ñ–æ—Ä–º–∞`

        *–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:*
        ‚Ä¢ `/train` - –Ω–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
        ‚Ä¢ –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Ç–µ–∫—Å—Ç–æ–º
        ‚Ä¢ –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç –æ—Ç–≤–µ—Ç –∏ –ø–æ–∫–∞–∂–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç

        *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*
        ‚Ä¢ `/stats` - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å

        *–ü–æ–¥–¥–µ—Ä–∂–∫–∞:*
        –ë–æ—Ç —Ö—Ä–∞–Ω–∏—Ç —Ç–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–±—è.
        –í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
        """
        await query.edit_message_text(text=help_text, parse_mode='Markdown')

# --- 7. –ó–ê–ü–£–°–ö –ë–û–¢–ê ---
def main():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞"""
    # –í–ê–ñ–ù–û: –¢–æ–∫–µ–Ω –æ—Ç @BotFather –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–∏—Ç—å –ù–ê –•–û–°–¢–ò–ù–ì–ï, –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è 'BOT_TOKEN'
    # –°–µ–π—á–∞—Å –∑–¥–µ—Å—å —Å—Ç–æ–∏—Ç –∑–∞–≥–ª—É—à–∫–∞. –ù–∞ Render.com –≤—ã —Å–æ–∑–¥–∞–¥–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é BOT_TOKEN —Å–æ —Å–≤–æ–∏–º –Ω–∞—Å—Ç–æ—è—â–∏–º —Ç–æ–∫–µ–Ω–æ–º.
    
    # –ó–∞–º–µ–Ω–∏—Ç–µ 'YOUR_BOT_TOKEN' –Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
    TOKEN = 'YOUR_BOT_TOKEN'  # –≠—Ç–æ –∑–∞–≥–ª—É—à–∫–∞! –ù–∞ Render.com –∑–∞–º–µ–Ω–∏—Ç—Å—è –Ω–∞ os.environ['BOT_TOKEN']
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler('start', start))
    application.add_handler(CommandHandler('add_word', add_word))
    application.add_handler(CommandHandler('add_kanji', add_kanji))
    application.add_handler(CommandHandler('add_grammar', add_grammar))
    application.add_handler(CommandHandler('train', train))
    application.add_handler(CommandHandler('stats', stats))
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(CallbackQueryHandler(button_handler))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, check_answer))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    logger.info("–ë–æ—Ç '–°–∞–º—É—Ä–∞–π –£—á–∏—Ç–µ–ª—å' –∑–∞–ø—É—â–µ–Ω!")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()